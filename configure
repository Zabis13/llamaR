#!/bin/sh

# Configure script for llamaR package

# Check that ggmlR is installed (warning only, actual check at compile time)
echo "Checking for ggmlR..."
GGMLR_LIB=$(${R_HOME}/bin/Rscript -e "cat(system.file('lib', package='ggmlR'))" 2>/dev/null)
if [ -z "$GGMLR_LIB" ] || [ ! -d "$GGMLR_LIB" ]; then
    echo "Note: ggmlR not found (will be checked at compile time)"
else
    if [ ! -f "$GGMLR_LIB/libggml.a" ]; then
        echo "Note: libggml.a not found in ggmlR (will be checked at compile time)"
    else
        echo "Found ggmlR at: $GGMLR_LIB"
    fi
fi

# --- Detect CPU SIMD features ---
echo "Detecting CPU SIMD features..."
CC_CMD="${CC:-cc}"

SIMD_CFLAGS=""
check_cflag() {
  if echo "int main(){return 0;}" | $CC_CMD $1 -x c -o /dev/null - 2>/dev/null; then
    SIMD_CFLAGS="$SIMD_CFLAGS $1"
    echo "  Found: $1"
    return 0
  fi
  return 1
}

SIMD_ARCH=$(uname -m 2>/dev/null || echo "unknown")
case "$SIMD_ARCH" in
  x86_64|i386|i686|amd64)
    check_cflag -msse3
    check_cflag -mssse3
    check_cflag -msse4.1
    check_cflag -msse4.2
    check_cflag -mavx
    check_cflag -mavx2
    check_cflag -mfma
    check_cflag -mf16c
    ;;
  *)
    echo "  Non-x86 architecture ($SIMD_ARCH), skipping x86 SIMD flags"
    ;;
esac

if [ -z "$SIMD_CFLAGS" ]; then
  echo "  No SIMD flags detected, using scalar fallback"
fi

# Get OpenMP flags from R
OPENMP_CXXFLAGS=""
MAKECONF=$(${R_HOME}/bin/Rscript -e "cat(R.home('etc'))" 2>/dev/null)/Makeconf
if [ -f "$MAKECONF" ]; then
    OPENMP_CXXFLAGS=$(grep "^SHLIB_OPENMP_CXXFLAGS" "$MAKECONF" | sed 's/.*= *//')
fi

# Check for Vulkan support (optional)
VULKAN_CPPFLAGS=""
VULKAN_LIBS=""

if pkg-config --exists vulkan 2>/dev/null; then
    echo "Vulkan support detected"
    VULKAN_CPPFLAGS="-DGGML_USE_VULKAN $(pkg-config --cflags vulkan)"
    VULKAN_LIBS="$(pkg-config --libs vulkan)"
else
    echo "Vulkan not found, building without GPU support"
fi

# Generate Makevars from template
sed -e "s|@OPENMP_CXXFLAGS@|${OPENMP_CXXFLAGS}|g" \
    -e "s|@VULKAN_CPPFLAGS@|${VULKAN_CPPFLAGS}|g" \
    -e "s|@VULKAN_LIBS@|${VULKAN_LIBS}|g" \
    -e "s|@SIMD_CFLAGS@|${SIMD_CFLAGS}|g" \
    src/Makevars.in > src/Makevars

echo "Configuration complete"
